name: Deploy to EC2

on:
  push:
    branches: [main, staging]

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "18"
          cache: "npm"

      - name: Install dependencies
        run: npm ci

      - name: Build application
        run: npm run build

      - name: Setup SSH
        uses: webfactory/ssh-agent@v0.8.0
        with:
          ssh-private-key: ${{ secrets.EC2_SSH_PRIVATE_KEY }}

      - name: Add EC2 host to known hosts
        run: |
          mkdir -p ~/.ssh
          ssh-keyscan -H ${{ secrets.EC2_HOST }} >> ~/.ssh/known_hosts

      - name: Deploy to EC2
        run: |
          # Determine environment based on branch
          if [ "${{ github.ref_name }}" = "main" ]; then
            ENV="production"
            PORT="3001"
          else
            ENV="staging"
            PORT="3000"
          fi

          echo "Deploying to $ENV environment on port $PORT"

                    echo "ðŸ“ Creating deployment directories..."
          # Create parent directory and deployment directory with proper permissions
          ssh ubuntu@${{ secrets.EC2_HOST }} "sudo mkdir -p /opt/pharma-tracker-api && sudo chown ubuntu:ubuntu /opt/pharma-tracker-api"
          ssh ubuntu@${{ secrets.EC2_HOST }} "mkdir -p /opt/pharma-tracker-api/$ENV"
          echo "âœ… Directories created successfully"

          echo "ðŸ” Verifying Node.js and npm availability..."
          # Verify Node.js and npm are available
          ssh ubuntu@${{ secrets.EC2_HOST }} "export PATH=\$PATH:/usr/bin:/usr/local/bin && node --version && npm --version"

          # Check Node.js version compatibility
          NODE_VERSION=$(ssh ubuntu@${{ secrets.EC2_HOST }} "export PATH=\$PATH:/usr/bin:/usr/local/bin && node --version | cut -d'v' -f2 | cut -d'.' -f1")
          if [ "$NODE_VERSION" -lt 20 ]; then
            echo "âŒ ERROR: Node.js version 20+ required, but found version $NODE_VERSION"
            echo "Please upgrade Node.js on EC2 instance"
            exit 1
          fi
          echo "âœ… Node.js and npm verified (version 20+)"

          echo "ðŸ“¦ Copying built application files..."
          # Copy built files (preserve dist structure)
          ssh ubuntu@${{ secrets.EC2_HOST }} "mkdir -p /opt/pharma-tracker-api/$ENV/dist"
          scp -r dist/* ubuntu@${{ secrets.EC2_HOST }}:/opt/pharma-tracker-api/$ENV/dist/
          echo "âœ… Application files copied"

          echo "ðŸ“‹ Copying package files..."
          # Copy package.json and package-lock.json for dependencies
          scp package.json package-lock.json ubuntu@${{ secrets.EC2_HOST }}:/opt/pharma-tracker-api/$ENV/
          echo "âœ… Package files copied"

          echo "âš™ï¸ Setting up environment configuration..."
          # Copy environment file and replace sensitive values
          scp env.$ENV ubuntu@${{ secrets.EC2_HOST }}:/opt/pharma-tracker-api/$ENV/.env
          echo "âœ… Environment file copied"

          echo "ðŸ” Injecting secrets into environment file..."
          # Replace sensitive values with secrets
          ssh ubuntu@${{ secrets.EC2_HOST }} "sed -i 's/will-be-replaced-at-deployment/${{ secrets.DB_PASSWORD }}/g' /opt/pharma-tracker-api/$ENV/.env"
          ssh ubuntu@${{ secrets.EC2_HOST }} "sed -i 's/will-be-replaced-at-deployment/${{ secrets.JWT_SECRET }}/g' /opt/pharma-tracker-api/$ENV/.env"
          echo "âœ… Secrets injected successfully"

          echo "ðŸ“¥ Installing production dependencies..."
          # Install production dependencies on EC2
          ssh ubuntu@${{ secrets.EC2_HOST }} "cd /opt/pharma-tracker-api/$ENV && export PATH=\$PATH:/usr/bin:/usr/local/bin && npm ci --omit=dev"
          echo "âœ… Dependencies installed"

          echo "ðŸ›‘ Stopping existing service (if running)..."
          # Stop existing service if running
          ssh ubuntu@${{ secrets.EC2_HOST }} "sudo systemctl stop pharma-tracker-$ENV || true"
          echo "âœ… Service stopped"

          echo "ðŸ”§ Creating systemd service file..."
          # Create systemd service file
          ssh ubuntu@${{ secrets.EC2_HOST }} "sudo tee /etc/systemd/system/pharma-tracker-$ENV.service > /dev/null << 'EOF'
          [Unit]
          Description=Pharma Tracker API - $ENV
          After=network.target

          [Service]
          Type=simple
          User=ubuntu
          WorkingDirectory=/opt/pharma-tracker-api/$ENV
          Environment=NODE_ENV=$ENV
          ExecStart=/usr/bin/node dist/main.js
          Restart=always
          RestartSec=10

          [Install]
          WantedBy=multi-user.target
          EOF"
          echo "âœ… Service file created"

          echo "ðŸ”„ Reloading systemd and starting service..."
          # Reload systemd and start service
          ssh ubuntu@${{ secrets.EC2_HOST }} "sudo systemctl daemon-reload && sudo systemctl enable pharma-tracker-$ENV && sudo systemctl start pharma-tracker-$ENV"
          echo "âœ… Service started"

          echo "â³ Waiting for service to fully start..."
          # Wait for service to start
          sleep 10
          echo "âœ… Wait period completed"

          echo "ðŸ“Š Checking service status..."
          # Check service status
          ssh ubuntu@${{ secrets.EC2_HOST }} "sudo systemctl status pharma-tracker-$ENV --no-pager"
          echo "âœ… Service status checked"

          echo "ðŸ” Checking service logs for errors..."
          # Check recent logs for error details
          ssh ubuntu@${{ secrets.EC2_HOST }} "sudo journalctl -u pharma-tracker-$ENV --no-pager -n 20"
          echo "âœ… Service logs checked"

          echo "ðŸ” Checking if port is in use..."
          # Check if port is already in use
          ssh ubuntu@${{ secrets.EC2_HOST }} "sudo netstat -tlnp | grep :$PORT || echo 'Port $PORT is available'"
          echo "âœ… Port availability checked"

          echo "ðŸ” Checking application directory and files..."
          # Check if all files are in place
          ssh ubuntu@${{ secrets.EC2_HOST }} "ls -la /opt/pharma-tracker-api/$ENV/"
          echo "âœ… Directory contents checked"

          echo "ðŸ§ª Testing application startup manually..."
          # Try to start the app manually to see detailed error
          ssh ubuntu@${{ secrets.EC2_HOST }} "cd /opt/pharma-tracker-api/$ENV && timeout 10s node dist/main.js || echo 'Manual startup test completed'"
          echo "âœ… Manual startup test completed"

          echo "ðŸŽ‰ Deployment to $ENV completed successfully!"
